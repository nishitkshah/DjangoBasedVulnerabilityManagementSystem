{% load  staticfiles %}
<html>
    <head>
        <script src="{% static "scripts/d3/d3.min.js" %}"></script>
    </head>
    <body>
        <div id="svg_container"></div>
        <script>
            let data = JSON.parse('{{ data | escapejs }}');
            let resources = data.resources;
            let width = 400,
                height = 400,
                border = 50,
                radius = (Math.min(width, height) -10) / 2,
                min_elem = d3.min(resources, function(d) { return d.risk_score; }),
                max_elem = d3.max(resources, function(d) { return d.risk_score; }),
                diff = max_elem-min_elem;

            let color = d3.scaleLinear()
                .domain([
                    d3.min(resources, function(d) { return d.risk_score; })-10,
                    d3.max(resources, function(d) { return d.risk_score; })+10
                ])
                .range([d3.rgb(30, 200, 30), d3.rgb(200, 30, 30)]);

            let svg = d3.select('#svg_container')
                .append('svg')
                .attr('width', width+2*border)
                .attr('height', height+2*border)
                .append('g')
                .attr('transform', 'translate(' + ((width / 2) + border) +',' + ((height / 2) + border) + ')');

            let arc = d3.arc()
                .innerRadius(Math.min(100, radius/2))
                .outerRadius(radius);

            let labelArc = d3.arc()
                .outerRadius(radius - 40)
                .innerRadius(radius/2);

            let pie = d3.pie()
                .value(function(d) { return d.risk_score; })
                .sort(null);

            let graph = svg.selectAll('path')
                .data(pie(resources))
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', function(d) {
                    return color(d.data.risk_score);
                })
                .attr('id', function(d) {
                    return d.data.resource_id;
                })
                .style('stroke', function(d) {
                    let elem_color = d3.rgb(color(d.data.risk_score)),
                        r_comp = elem_color.r,
                        g_comp = elem_color.g,
                        b_comp = elem_color.b;
                    if(r_comp>=g_comp){
                        r_comp = 255;
                        g_comp = 0;
                    }else{
                        r_comp = 0;
                        g_comp = 255;
                    }
                    return d3.rgb(r_comp, g_comp, b_comp);
                })
                .style('stroke-width', '5')
                .on("mouseover", function(d) {
                    this.style.cursor='pointer';
                    // Calculate angle bisector
                    var ang = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    // Transformate to SVG space
                    ang = (ang - (Math.PI / 2)) * -1;
                    // Calculate a 10% radius displacement
                    var x = Math.cos(ang) * radius * 0.1;
                    var y = Math.sin(ang) * radius * -0.1;
                    d3.select(this).transition()
                    .duration(100).attr("transform", "translate(" + x + "," + y + ")");
                })
                .on("mouseout", function(d) {
                    d3.select(this).transition()
                    .duration(150).attr("transform", "translate(0,0)");
                })
                .on("click", function () {
                    location.href = "{% url 'nodes_report' %}"+data.id+"/"+this.id+"/";
                });
        </script>
    </body>
</html>

